<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to Health Association Analysis for Movement Behaviour Data • week2DataChallenge</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Health Association Analysis for Movement Behaviour Data">
<meta property="og:description" content="week2DataChallenge">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">week2DataChallenge</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/0_GettingSetupWithRStudio.html">Getting Set Up With RStudio</a>
    </li>
    <li>
      <a href="../articles/1_DataPrep.html">Data Preparation</a>
    </li>
    <li>
      <a href="../articles/2_HealthAssociationAnalysis.html">Introduction to Health Association Analysis for Movement Behaviour Data</a>
    </li>
    <li>
      <a href="../articles/3_IntroToCompositionalDataAnalysis.html">Compositional Data Analysis Tutorial</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="2_HealthAssociationAnalysis_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to Health Association Analysis for Movement Behaviour Data</h1>
            
      
      
      <div class="hidden name"><code>2_HealthAssociationAnalysis.Rmd</code></div>

    </div>

    
    
<p>In this tutorial, we will go through a basic health association analysis using movement behaviour data.</p>
<p>As well as external packages, we’ll use some helper functions we’ve prepared previously. If you want to modify them, you can find them in the file <code>R/utils.R</code> on the GitHub page (see also intro notes).</p>
<div id="load-in-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-in-data" class="anchor"></a>Load in data</h1>
<p>First we will load required packages, and the data we already prepared.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First we need to install packages that aren't already present. </span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman" class="external-link">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: pacman</span>
<span class="co">#&gt; Warning: package 'pacman' was built under R version 4.0.4</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html" class="external-link">p_load</a></span><span class="op">(</span><span class="va">devtools</span>, <span class="va">ggtern</span>, <span class="va">ggplot2</span>, <span class="va">reshape2</span>, <span class="va">data.table</span><span class="op">)</span>

<span class="co"># If you've installed this as a package you can load helper functions like this</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">week2DataChallenge</span><span class="op">)</span>

<span class="co"># We then load the data prepared in the last tutorial. </span>
<span class="va">dAll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">fread</span><span class="op">(</span><span class="st">"J:\\cdt_prep\\week2_wearables_data_challenge_2021\\week2DataChallenge\\data_and_data_prep\\ukb-data-challenge.csv"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Substitute with the correct path! </span></code></pre></div>
<p>We need to make sure some variables are factors, as subsequent code relies on that. If you change the variables you use, you might need to add some variables here. I also added in a variable on the scale</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dAll</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">Sex</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">ethnicity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ethnicity</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">smoking</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">smoking</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">alcohol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">alcohol</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">broadAgeGroup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">broadAgeGroup</span><span class="op">)</span>

<span class="va">behaviour_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MVPA"</span>, <span class="st">"LIPA"</span>, <span class="st">"SB"</span>, <span class="st">"sleep"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">variable</span> <span class="kw">in</span> <span class="va">behaviour_vars</span><span class="op">)</span><span class="op">{</span>
  <span class="va">dAll</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"_min_per_day"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">24</span><span class="op">*</span><span class="fl">60</span><span class="op">*</span><span class="va">dAll</span><span class="op">[</span>, <span class="va">variable</span><span class="op">]</span>
  <span class="va">dAll</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"_hr_per_day"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">24</span><span class="op">*</span><span class="va">dAll</span><span class="op">[</span>, <span class="va">variable</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="describe-and-explore-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#describe-and-explore-the-data" class="anchor"></a>Describe and explore the data</h1>
<div id="tables-to-describe-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#tables-to-describe-the-data" class="anchor"></a>Tables to describe the data</h2>
<p>The following code constructs a table to describe accelerometer measured attributes by conventional groupings (e.g. age, sex, self-rated health, season). It does two-way analysis of variance, adjusted for the variables listed as confounder columns.</p>
<p>The code might look excessively complicated, because we wanted to save it as a html output. You could do the same thing using R data frames, and then work out formatting afterwards…</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify groups (i.e. major row blocks)</span>
<span class="va">groups</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"broadAgeGroup"</span>, <span class="st">"sex"</span><span class="op">)</span> <span class="co"># Fill this in with groups you want to look at</span>

<span class="co"># specify accelerometer outcomes (i.e. column headings)</span>
<span class="va">outcomeCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"acc.overall.avg"</span>, <span class="st">"LIPA_hr_per_day"</span><span class="op">)</span> <span class="co"># Fill this in with a list of outcomes you want to look at</span>

<span class="co"># specify two-way analysis of variance confounder columns</span>
<span class="va">confounderCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"broadAgeGroup"</span>, <span class="st">"sex"</span>, <span class="st">"ethnicity"</span>, <span class="st">"smoking"</span>, <span class="st">"alcohol"</span><span class="op">)</span> <span class="co"># Fill this in with what </span>
<span class="co">#  you want to adjust for when running the ANOVA</span>

<span class="co"># specify output file name</span>
<span class="va">outHTML</span><span class="op">&lt;-</span><span class="st">'table1.html'</span>

<span class="co"># write table header code</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="st">'&lt;html&gt;&lt;head&gt;&lt;title&gt;Acc summary table&lt;/title&gt;&lt;/head&gt;&lt;table&gt;'</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;tr&gt;&lt;th&gt;&lt;/th&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;th&gt;Individuals&lt;/th&gt;'</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">col</span>  <span class="kw">in</span> <span class="va">outcomeCols</span><span class="op">)</span><span class="op">{</span>
    <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;th&gt;'</span>, <span class="va">col</span>, <span class="st">'&lt;/th&gt;'</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/tr&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;tr&gt;&lt;th&gt;&lt;/th&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;th&gt;[ n ]&lt;/th&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;th&gt;[mean &amp;plusmn stdev m&lt;i&gt;g&lt;/i&gt;]&lt;/th&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;th&gt;[mean &amp;plusmn stdev LIPA hr/dy]&lt;/th&gt;'</span><span class="op">)</span>

<span class="co"># iterate through each major row block</span>
<span class="kw">for</span><span class="op">(</span><span class="va">group</span> <span class="kw">in</span> <span class="va">groups</span><span class="op">)</span><span class="op">{</span>
    <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'\n&lt;tr&gt;&lt;td&gt;&lt;b&gt;'</span>, <span class="va">group</span>, <span class="st">'&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;'</span><span class="op">)</span>
    <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span class="op">)</span>
    <span class="va">group.tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">4</span>, nrow<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#df to store outputs for subsequent effect size calculations</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">group.tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"item"</span>, <span class="st">"outcome"</span>, <span class="st">"avg"</span>, <span class="st">"stdev"</span><span class="op">)</span>
    <span class="co"># report mean/stdev/n summary stats for each "item" in group e.g. each age categor</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">item</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">[[</span><span class="va">group</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;tr&gt;'</span><span class="op">)</span>
        <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;td&gt;'</span>, <span class="va">item</span>, <span class="st">'&lt;/td&gt;'</span><span class="op">)</span>
        <span class="co"># temp store of all relevant outcome data related to this "item"</span>
        <span class="va">itemData</span> <span class="op">&lt;-</span> <span class="va">dAll</span><span class="op">[</span><span class="va">dAll</span><span class="op">[[</span><span class="va">group</span><span class="op">]</span><span class="op">]</span><span class="op">==</span><span class="va">item</span>, <span class="va">outcomeCols</span><span class="op">]</span>
        <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">itemData</span><span class="op">)</span>
        <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;td align="center"&gt;'</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">n</span>,big.mark<span class="op">=</span><span class="st">","</span><span class="op">)</span>, <span class="st">'&lt;/td&gt;'</span><span class="op">)</span>

        <span class="co"># iterate through each acceleroemter outcome (i.e. each column)</span>
        <span class="kw">for</span><span class="op">(</span><span class="va">outcome</span> <span class="kw">in</span> <span class="va">outcomeCols</span><span class="op">)</span><span class="op">{</span>
            <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="fu"><a href="../reference/summary4tableHTML_simple.html">summary4tableHTML_simple</a></span><span class="op">(</span><span class="va">itemData</span><span class="op">[[</span><span class="va">outcome</span><span class="op">]</span><span class="op">]</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
            <span class="va">avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">itemData</span><span class="op">[[</span><span class="va">outcome</span><span class="op">]</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
            <span class="va">stdev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">itemData</span><span class="op">[[</span><span class="va">outcome</span><span class="op">]</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
            <span class="va">group.tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">group.tmp</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>item<span class="op">=</span> <span class="va">item</span>, outcome<span class="op">=</span><span class="va">outcome</span>,
                                     avg<span class="op">=</span><span class="va">avg</span>, stdev<span class="op">=</span><span class="va">stdev</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/tr&gt;'</span><span class="op">)</span>
    <span class="op">}</span>


<span class="co"># now calculate two-way ANOVA p-value between subgroup "items" for each acc outcome</span>
<span class="va">html</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;tr&gt;&lt;td&gt;p value&lt;sup&gt;A&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;'</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">outcome</span> <span class="kw">in</span> <span class="va">outcomeCols</span><span class="op">)</span><span class="op">{</span>
  <span class="va">tmpconfounderCols</span> <span class="op">&lt;-</span> <span class="va">confounderCols</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">group</span> <span class="op">%in%</span> <span class="va">tmpconfounderCols</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
     <span class="va">tmpconfounderCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">tmpconfounderCols</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">formulaStr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">outcome</span>,<span class="st">' ~ '</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">tmpconfounderCols</span>, collapse<span class="op">=</span><span class="st">' + '</span><span class="op">)</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">''</span><span class="op">)</span>
  <span class="va">itemANOVA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aov.html" class="external-link">aov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">formulaStr</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dAll</span><span class="op">)</span>
  <span class="co"># extract p-value for specific variable of interest</span>
  
  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">itemANOVA</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="va">groupResult</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Pr(&gt;F)"</span><span class="op">]</span>
   <span class="co"># write formatted p-value to html</span>
  
  <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="fu"><a href="../reference/pValueHTML_cell.html">pValueHTML_cell</a></span><span class="op">(</span><span class="va">groupResult</span>,<span class="fl">1e-300</span><span class="op">)</span><span class="op">)</span>        
 <span class="op">}</span>
 <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/tr&gt;'</span><span class="op">)</span>
 
 <span class="co"># calculate effect size between subgroup "items" for each acc outcome</span>
 <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">"&lt;tr&gt;&lt;td&gt;Cohen's d&lt;/td&gt;&lt;td&gt;&lt;/td&gt;"</span><span class="op">)</span>
 <span class="kw">for</span><span class="op">(</span><span class="va">outcome</span> <span class="kw">in</span> <span class="va">outcomeCols</span><span class="op">)</span><span class="op">{</span>
   <span class="co"># read relevant subgroup mean/stdev values stored from summary stats derived earlier</span>
  <span class="va">grouping</span> <span class="op">&lt;-</span><span class="va">group.tmp</span><span class="op">[</span><span class="op">(</span><span class="va">group.tmp</span><span class="op">[</span>, <span class="st">"outcome"</span><span class="op">]</span> <span class="op">==</span><span class="va">outcome</span><span class="op">)</span>,<span class="op">]</span>
  <span class="va">minVal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">grouping</span><span class="op">[</span><span class="st">'avg'</span><span class="op">]</span><span class="op">)</span>
  <span class="va">maxVal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">grouping</span><span class="op">[</span><span class="st">'avg'</span><span class="op">]</span><span class="op">)</span>
  <span class="va">lowest</span> <span class="op">&lt;-</span> <span class="va">grouping</span><span class="op">[</span><span class="op">(</span><span class="va">grouping</span><span class="op">$</span><span class="va">avg</span><span class="op">==</span><span class="va">minVal</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'avg'</span>,<span class="st">'stdev'</span><span class="op">)</span><span class="op">]</span>
  <span class="va">highest</span> <span class="op">&lt;-</span> <span class="va">grouping</span><span class="op">[</span><span class="op">(</span><span class="va">grouping</span><span class="op">$</span><span class="va">avg</span><span class="op">==</span><span class="va">maxVal</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'avg'</span>,<span class="st">'stdev'</span><span class="op">)</span><span class="op">]</span>
  
  <span class="co"># calculate Cohen's d effect size and format for HTML output</span>
  <span class="va">cohenD</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/effectSize.html">effectSize</a></span><span class="op">(</span><span class="va">lowest</span><span class="op">$</span><span class="va">avg</span>,<span class="va">lowest</span><span class="op">$</span><span class="va">stdev</span>,<span class="va">highest</span><span class="op">$</span><span class="va">avg</span>,<span class="va">highest</span><span class="op">$</span><span class="va">stdev</span><span class="op">)</span>
  <span class="va">cohenD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cohenD</span>, <span class="fl">2</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
  <span class="va">cohenD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">'^(-)?0[.]'</span>, <span class="st">'\\1.'</span>, <span class="va">cohenD</span><span class="op">)</span>
  <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;td align="center"&gt;'</span>, <span class="va">cohenD</span>, <span class="st">'&lt;/td&gt;'</span><span class="op">)</span>
 <span class="op">}</span>

  <span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/tr&gt;'</span><span class="op">)</span>

<span class="op">}</span>
<span class="co">#finalise HTML table</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'\n&lt;/table&gt;'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;br&gt;&lt;i&gt;&lt;sup&gt;A&lt;/sup&gt; Age, sex:&lt;/i&gt; '</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'Two-way analysis of variance test used to compare metrics between groups'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'adjusting for age, sex, ethnicity, smoking status and alcohol consumption frequency.'</span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">html</span>, <span class="st">'&lt;/html&gt;'</span><span class="op">)</span>
<span class="co"># and write html to file</span>
<span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="va">html</span>, file <span class="op">=</span> <span class="va">outHTML</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'standard table done, written to: '</span>, <span class="va">outHTML</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "standard table done, written to: table1.html"</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_url.html" class="external-link">include_url</a></span><span class="op">(</span><span class="va">outHTML</span><span class="op">)</span></code></pre></div>
<iframe src="table1.html" width="1152" height="400px">
</iframe>
<p>You might think more about the distribution of some of the accelerometry-derived variables - for some, this may not be the best way to characterise them (for example, the distribution of MVPA is very skewed). But it’s good for a first description!</p>
</div>
<div id="plots-to-describe-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#plots-to-describe-the-data" class="anchor"></a>Plots to describe the data</h2>
<p>We’ll also plot some of the variables to get a feel for how they’re distributed.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># overall physical activity</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">acc.overall.avg</span>, breaks<span class="op">=</span><span class="fl">1000</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-2-1.png" width="1152"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">#look at deciles</span>
<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">acc.overall.avg</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.50</span>, <span class="fl">0.90</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt;      10%      50%      90% </span>
<span class="co">#&gt; 18.74053 27.14073 38.46044</span>

<span class="co"># MVPA</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">MVPA_min_per_day</span>, breaks<span class="op">=</span><span class="fl">1000</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-2-2.png" width="1152"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">#look at deciles</span>
<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">acc.overall.avg</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.50</span>, <span class="fl">0.90</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt;      10%      50%      90% </span>
<span class="co">#&gt; 18.74053 27.14073 38.46044</span></code></pre></div>
<p>Now let’s look descriptively at something we might expect to vary as activity status varies: BMI.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotVarAndQuintile.html">plotVarAndQuintile</a></span><span class="op">(</span><span class="va">dAll</span>, <span class="co"># dataset</span>
                   <span class="st">'acc.overall.avg'</span>, <span class="co"># exposure</span>
                   <span class="st">'BMI'</span>, <span class="co"># outcome</span>
                   <span class="cn">FALSE</span> <span class="co"># [TRUE/FALSE] save plots to PDF</span>
                  <span class="op">)</span></code></pre></div>
<p><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-3-1.png" width="1152"></p>
<p>Let’s have a look at some of the machine-learned variables, to see if we believe them! Here we’ll look at plots of probability of being in a particular behaviour by time of day:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotAverageDay.html">plotAverageDay</a></span><span class="op">(</span><span class="va">dAll</span>, <span class="st">"sleep.hourOfDay."</span>, <span class="st">".avg"</span>, <span class="st">"Sleep (probability)"</span><span class="op">)</span></code></pre></div>
<p><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-4-1.png" width="1152"></p>
<p>You might want to extend this function to plot the different profiles of different groups (e.g. healthy/ unhealthy individuals, or age groups).</p>
</div>
</div>
<div id="run-a-simple-health-association-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#run-a-simple-health-association-analysis" class="anchor"></a>Run a simple health association analysis</h1>
<p>Let’s run a minimally (age and sex) adjusted linear model for BMI, against fifths of average acceleration vector magnitude. This is attempting to model statistically the association we were looking at descriptively in the end of the last section.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dAll</span><span class="op">$</span><span class="va">acc_quintiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">acc.overall.avg</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">acc.overall.avg</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># cut at quintiles</span>
<span class="va">min_adj_lm_BMI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">BMI</span> <span class="op">~</span><span class="va">acc_quintiles</span> <span class="op">+</span> <span class="va">broadAgeGroup</span><span class="op">+</span> <span class="va">sex</span>, <span class="va">dAll</span><span class="op">)</span></code></pre></div>
<p>We can look at the model summary:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">min_adj_lm_BMI</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = BMI ~ acc_quintiles + broadAgeGroup + sex, data = dAll)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -14.945  -2.925  -0.615   2.188  40.351 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                           Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)              28.391317   0.060113 472.296   &lt;2e-16 ***</span>
<span class="co">#&gt; acc_quintiles(21.4,25.3] -1.408577   0.044357 -31.755   &lt;2e-16 ***</span>
<span class="co">#&gt; acc_quintiles(25.3,29.1] -2.102733   0.044597 -47.149   &lt;2e-16 ***</span>
<span class="co">#&gt; acc_quintiles(29.1,34.1] -2.687002   0.044913 -59.826   &lt;2e-16 ***</span>
<span class="co">#&gt; acc_quintiles(34.1,99]   -3.694102   0.045533 -81.129   &lt;2e-16 ***</span>
<span class="co">#&gt; broadAgeGroup50-59        0.083526   0.055061   1.517    0.129    </span>
<span class="co">#&gt; broadAgeGroup60-69       -0.007884   0.053192  -0.148    0.882    </span>
<span class="co">#&gt; broadAgeGroup70-79       -0.506534   0.059504  -8.513   &lt;2e-16 ***</span>
<span class="co">#&gt; sexMale                   0.856398   0.028314  30.246   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 4.336 on 96368 degrees of freedom</span>
<span class="co">#&gt;   (218 observations deleted due to missingness)</span>
<span class="co">#&gt; Multiple R-squared:  0.08386,    Adjusted R-squared:  0.08378 </span>
<span class="co">#&gt; F-statistic:  1103 on 8 and 96368 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>We can also look at the <a href="http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/" class="external-link">model diagnostics</a> to understand more about the fit of the model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">min_adj_lm_BMI</span><span class="op">)</span></code></pre></div>
<p><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="1152"><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-7-2.png" width="1152"><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-7-3.png" width="1152"><img src="2_HealthAssociationAnalysis_files/figure-html/unnamed-chunk-7-4.png" width="1152"> The problem with the Q-Q plot is caused by the BMI distribution - log-transforming the outcome would be a good option in this case.</p>
</div>
<div id="next-steps-for-modelling" class="section level1">
<h1 class="hasAnchor">
<a href="#next-steps-for-modelling" class="anchor"></a>Next steps for modelling</h1>
<p>Here we’ve looked at a very simple linear model. Next steps might be:</p>
<ul>
<li>adjusting for more confounders</li>
<li>refining the definition of the exposure or looking at different exposure variables</li>
<li>looking at different outcomes</li>
<li>logistic regression for prevalent disease (use the <code>glm</code> function)</li>
<li>Cox regression for incident disease (see for example the <code>survival</code> package and the <code>coxph</code> function)</li>
</ul>
</div>
<div id="getting-started-with-cox-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started-with-cox-regression" class="anchor"></a>Getting started with Cox regression</h1>
<p>For example, here’s an initial Cox regression analysis associating quintiles of overall acceleration with incident ischaemic heart disease.</p>
<p>First we need to set up the data in an appropriate format, with a follow-up time and an indicator at exit indicating whether the participant exited due to an event or due to being censored (either the participant died of another cause or study data ended before they had an event).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Exclude participants with prevalent IHD</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.prevalent</span><span class="op">)</span>, <span class="st">" were excluded due to prior ischaemic heart disease"</span><span class="op">)</span>
<span class="co">#&gt; 4912  were excluded due to prior ischaemic heart disease</span>
<span class="va">dAll</span> <span class="op">&lt;-</span> <span class="va">dAll</span><span class="op">[</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.prevalent</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>

<span class="co"># We need to process participants who died as they are censored earlier</span>
<span class="va">death</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"J:/data_and_prep_utilities/59070_application/health_outcomes/death.txt"</span>,
           sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">died</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">died</span><span class="op">[</span><span class="va">dAll</span><span class="op">$</span><span class="va">eid</span> <span class="op">%in%</span> <span class="va">death</span><span class="op">$</span><span class="va">eid</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">dAll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"date_of_death"</span><span class="op">]</span><span class="op">]</span>, <span class="va">death</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eid"</span>, <span class="st">"date_of_death"</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="st">"eid"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">died</span><span class="op">)</span>, <span class="st">"participants died"</span><span class="op">)</span>
<span class="co">#&gt; 2317 participants died</span>

<span class="co"># Note censoring dates of 31.12.20 in England/Scotland and 28.02.2018 in Wales (https://biobank.ndph.ox.ac.uk/ukb/exinfo.cgi?src=Data_providers_and_dates) </span>
<span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"31/12/2020"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span><span class="op">[</span><span class="va">dAll</span><span class="op">$</span><span class="va">UkBiobankAssessCent</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cardiff"</span>, <span class="st">"Wrexham"</span>, <span class="st">"Swansea"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"28/02/2018"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span>

<span class="co"># For people who died, we need to censor them at the earliest of their date of death and overall censoring (e.g. a participant in Wales who died in 2020 should nonetheless be # censored at 28.02.2018 - if they had an IHD event in 2019 we wouldn't know about it</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span><span class="op">[</span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">died</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span><span class="op">[</span><span class="va">dAll</span><span class="op">$</span><span class="va">died</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">date_of_death</span><span class="op">[</span><span class="va">dAll</span><span class="op">$</span><span class="va">died</span> <span class="op">==</span><span class="fl">1</span><span class="op">]</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Add follow up variable (censor date for participants without an event, event date for participants with an event)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">follow_up</span> <span class="op">&lt;-</span> <span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">follow_up</span><span class="op">[</span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.incident</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease</span><span class="op">[</span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.incident</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span>, <span class="va">dAll</span><span class="op">$</span><span class="va">censoring</span><span class="op">[</span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.incident</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Note event status at censoring (again, care taken as there are some instances of entries in the data after censoring)</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">IHD_at_exit</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">dAll</span><span class="op">$</span><span class="va">IHD_at_exit</span><span class="op">[</span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease.incident</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">ischaemic.heart.disease</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span> <span class="op">==</span> <span class="va">dAll</span><span class="op">$</span><span class="va">follow_up</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">IHD_at_exit</span><span class="op">)</span>, <span class="st">" had incident hospital diagnosed ischaemic heart disease within the follow up period"</span><span class="op">)</span>
<span class="co">#&gt; 3133  had incident hospital diagnosed ischaemic heart disease within the follow up period</span>

<span class="co"># Calculate follow up time </span>
<span class="va">dAll</span><span class="op">$</span><span class="va">fu_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">follow_up</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">dAll</span><span class="op">$</span><span class="va">EndTimWear</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span>, tz <span class="op">=</span> <span class="st">"Europe/London"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>WARNING: when working with date data, especially when dates are only present for some participants, it is very easy to write code which behaves in strange ways… I did so several times when writing this example (and don’t guarantee it’s error-free now). It is well worth inspecting your data repeatedly to check that the code is doing what you expect. [Obviously not shown here as I can’t print the data frame on the internet… Bear this in mind when using RMarkdown].</p>
<p>We now have an event status indicator at exit and a follow-up time variable, which is enough to run a Cox model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span>
<span class="va">cox_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">fu_time</span>, <span class="va">IHD_at_exit</span><span class="op">)</span> <span class="op">~</span> <span class="va">broadAgeGroup</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">acc_quintiles</span>, <span class="va">dAll</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; coxph(formula = Surv(fu_time, IHD_at_exit) ~ broadAgeGroup + </span>
<span class="co">#&gt;     sex + acc_quintiles, data = dAll)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   n= 91683, number of events= 3133 </span>
<span class="co">#&gt;    (1 observation deleted due to missingness)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                              coef exp(coef) se(coef)      z Pr(&gt;|z|)    </span>
<span class="co">#&gt; broadAgeGroup50-59        0.69622   2.00615  0.12645  5.506 3.67e-08 ***</span>
<span class="co">#&gt; broadAgeGroup60-69        1.40226   4.06436  0.12090 11.599  &lt; 2e-16 ***</span>
<span class="co">#&gt; broadAgeGroup70-79        1.84127   6.30455  0.12284 14.989  &lt; 2e-16 ***</span>
<span class="co">#&gt; sexMale                   0.77106   2.16206  0.03708 20.792  &lt; 2e-16 ***</span>
<span class="co">#&gt; acc_quintiles(21.4,25.3] -0.17839   0.83661  0.04985 -3.578 0.000346 ***</span>
<span class="co">#&gt; acc_quintiles(25.3,29.1] -0.34828   0.70590  0.05355 -6.504 7.84e-11 ***</span>
<span class="co">#&gt; acc_quintiles(29.1,34.1] -0.37116   0.68993  0.05530 -6.712 1.92e-11 ***</span>
<span class="co">#&gt; acc_quintiles(34.1,99]   -0.59452   0.55183  0.06194 -9.599  &lt; 2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                          exp(coef) exp(-coef) lower .95 upper .95</span>
<span class="co">#&gt; broadAgeGroup50-59          2.0061     0.4985    1.5658    2.5704</span>
<span class="co">#&gt; broadAgeGroup60-69          4.0644     0.2460    3.2069    5.1511</span>
<span class="co">#&gt; broadAgeGroup70-79          6.3045     0.1586    4.9555    8.0208</span>
<span class="co">#&gt; sexMale                     2.1621     0.4625    2.0105    2.3251</span>
<span class="co">#&gt; acc_quintiles(21.4,25.3]    0.8366     1.1953    0.7587    0.9225</span>
<span class="co">#&gt; acc_quintiles(25.3,29.1]    0.7059     1.4166    0.6356    0.7840</span>
<span class="co">#&gt; acc_quintiles(29.1,34.1]    0.6899     1.4494    0.6191    0.7689</span>
<span class="co">#&gt; acc_quintiles(34.1,99]      0.5518     1.8122    0.4887    0.6231</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Concordance= 0.694  (se = 0.004 )</span>
<span class="co">#&gt; Likelihood ratio test= 1488  on 8 df,   p=&lt;2e-16</span>
<span class="co">#&gt; Wald test            = 1337  on 8 df,   p=&lt;2e-16</span>
<span class="co">#&gt; Score (logrank) test = 1492  on 8 df,   p=&lt;2e-16</span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp(coef)</a></code> column gives the hazard ratio. Not surprisingly, older age and male sex are associated with higher risk of ischaemic heart disease, whereas a higher level of activity is associated with a lower risk of ischaemic heart disease. Again, you would probably want to substantiall refine this model. For example, it would be good to adjust for possible confounders, and you might also want to look into model diagnostics to understand if assumptions, such as the <a href="https://thomaselove.github.io/432-notes/cox-regression-models-for-survival-data-example-1.html" class="external-link">proportional hazards assumption</a> (see section 23.2.5 and 23.2.6).</p>
<p>A bonus: here we’ve adjusted the model for baseline age (in fact, in very crude groups) and used time-on-study as the timescale in the Cox regression analysis. This is what most introductory texts do. However, in epidemiological studies, time-on-study might not be the most relevant timescale. <a href="https://journals.lww.com/epidem/Fulltext/2012/07000/Proportional_Hazards_Regression_in_Epidemiologic.9.aspx" class="external-link">Age might be a more appropriate timescale…</a></p>
<p>Have fun! :)</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by .</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
